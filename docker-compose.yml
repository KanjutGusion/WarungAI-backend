services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: warungai-api
    restart: always
    # map host HOST_PORT -> container 3000
    ports:
      - '${HOST_PORT:-3001}:3000'
    env_file:
      - .env
    environment:
      - PORT=${HOST_PORT}
    networks:
      - warungnet
    command: npm run start:prod
    healthcheck:
      # health check uses container internal port 3000 (stable)
      test:
        [
          'CMD-SHELL',
          'curl -f http://localhost:${HOST_PORT}/api/health || exit 1',
        ]
      interval: 25s
      timeout: 10s
      retries: 5
      start_period: 20s

networks:
  warungnet:
    driver: bridge
